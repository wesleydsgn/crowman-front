<script>
  const API = "https://crowman-promocoes-api.onrender.com/promocoes";
  const BOT_TOKEN = "8104519401:AAFCSz66tVAZTP4p9INqNCjnazufFsGeg8I"; // IMPORTANTE!
  let cache = [];

  // Busca foto real do Telegram
  async function getImageUrl(fileId) {
    try {
      const resp = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/getFile?file_id=${fileId}`);
      const data = await resp.json();

      if (!data.ok) return null;

      return `https://api.telegram.org/file/bot${BOT_TOKEN}/${data.result.file_path}`;
    } catch (e) {
      return null;
    }
  }

  function smartTags(texto) {
    const tags = [];
    const map = {
      "cupom": /cupom|cupon|cÃ³digo/i,
      "frete grÃ¡tis": /frete/i,
      "smartphone": /celular|iphone|samsung|xiaomi|motorola/i,
      "pc gamer": /gamer|rtx|ssd|ryzen|intel|placa/i,
      "roupas": /camisa|moletom|nike|adidas|roupa/i,
      "eletrÃ´nicos": /tv|monitor|headset|fone/i
    };
    for (const t in map) if (map[t].test(texto)) tags.push(t);
    return tags;
  }

  async function carregar() {
    const res = await fetch(API);
    const dados = await res.json();

    if (cache.length > 0 && dados[0]?.id !== cache[0]?.id) {
      showToast();
    }

    cache = dados;
    render(dados);
  }

  async function render(lista) {
    const el = document.getElementById("lista");
    el.innerHTML = "";

    for (const p of lista) {
      let imgTag = "";

      if (p.imagem) {
        const url = await getImageUrl(p.imagem);
        if (url) imgTag = `<img src="${url}" />`;
      }

      const tags = smartTags(p.texto)
        .map(t => `<span>${t}</span>`).join("");

      el.innerHTML += `
        <div class="card" onclick="openModal(${p.id})">
          ${imgTag}
          <div class="tagList">${tags}</div>
          <p>${p.texto.substring(0, 120)}...</p>
        </div>
      `;
    }
  }

  async function openModal(id) {
    const p = cache.find(x => x.id === id);
    const link = p.texto.match(/https?:\/\/[^\s]+/);

    let imgTag = "";
    if (p.imagem) {
      const url = await getImageUrl(p.imagem);
      if (url) imgTag = `<img src="${url}" style="width:100%;border-radius:10px;" />`;
    }

    document.getElementById("modalBody").innerHTML = `
      ${imgTag}
      <p style="margin-top:15px;">${p.texto.replace(/\n/g, '<br>')}</p>
      ${link ? `<a class='btnOferta' href='${link[0]}' target='_blank'>Abrir Oferta ðŸ”¥</a>` : ""}
    `;

    document.getElementById("modal").style.display = "flex";
  }

  function closeModal() {
    document.getElementById("modal").style.display = "none";
  }

  document.getElementById("search").addEventListener("keyup", e => {
    const q = e.target.value.toLowerCase();
    const filtrado = cache.filter(x => x.texto.toLowerCase().includes(q));
    render(filtrado);
  });

  function showToast() {
    const t = document.getElementById("toast");
    t.style.display = "block";
    setTimeout(() => t.style.display = "none", 3000);
  }

  carregar();
  setInterval(carregar, 5000);
</script>
